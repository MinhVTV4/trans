<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiên Dịch Thời Gian Thực - Hai Chiều</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .transcript-box-container {
            position: relative; 
        }
        .transcript-box {
            min-height: 80px; 
            border: 1px solid #d1d5db;
            padding: 10px;
            padding-right: 30px; 
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            overflow-y: auto; 
            max-height: 120px; 
        }
        #rawTranscriptBox { 
            background-color: #f9fafb; /* Lightest gray for raw, less prominent */
            color: #4b5563; /* Slightly darker text for raw */
            max-height: 100px;
            margin-bottom: 1rem; 
            font-style: normal; /* No more italic for raw, as it's the live input */
        }
        .transcript-action-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #9ca3af; 
            cursor: pointer;
            font-size: 0.9rem;
            padding: 2px;
        }
        .transcript-action-btn:hover {
            color: #4b5563; 
        }
        .btn {
            padding: 8px 16px; 
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.875rem; 
        }
        .btn-start { background-color: #2563eb; color: white; }
        .btn-start:hover { background-color: #1d4ed8; }
        .btn-stop { background-color: #dc2626; color: white; }
        .btn-stop:hover { background-color: #b91c1c; }
        .btn-primary { background-color: #16a34a; color: white; } 
        .btn-primary:hover { background-color: #15803d; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-icon { padding: 6px 10px; }


        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-recording { background-color: #ef4444; animation: pulse 1.5s infinite; }
        .status-idle { background-color: #6b7280; }
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.7; }
        }
        .message-box {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            max-width: 90%;
            text-align: center;
            font-size: 0.875rem;
        }
        .message-box.show { opacity: 1; }
        .permission-notice {
            background-color: #fffbeb; color: #92400e;
            padding: 8px; border-radius: 8px; border: 1px solid #fef3c7;
            margin-bottom: 0.75rem; text-align: center; font-size: 0.8rem;
        }
        .auth-form input, .language-select select {
            border: 1px solid #d1d5db; padding: 8px 10px; border-radius: 6px; margin-bottom: 0.5rem; width: 100%;
            font-size: 0.875rem;
        }
         .language-select select { width: auto; min-width: 120px;}
        .auth-container, .history-container, .language-select-container, .raw-transcript-container {
            border: 1px solid #e5e7eb; padding: 1rem; border-radius: 8px; margin-top: 1rem; background-color: #f9fafb;
        }
        .auth-status { font-size: 0.8rem; color: #4b5563; margin-top: 0.5rem; text-align: center; }
        .history-item {
            background-color: #ffffff;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        .history-item p { margin-bottom: 4px; }
        .history-item .original { color: #374151; }
        .history-item .translated { color: #1d4ed8; font-weight: 500; }
        .history-item .timestamp { font-size: 0.75rem; color: #6b7280; text-align: right; }
        #translationHistory { max-height: 200px; overflow-y: auto; }
        
        .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
            vertical-align: text-bottom;
            margin-left: 5px;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-2 sm:p-4">

    <div class="w-full max-w-xl bg-white p-4 sm:p-6 rounded-xl shadow-xl">
        <header class="text-center mb-4">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Phiên Dịch Thời Gian Thực</h1>
            <p class="text-xs sm:text-sm text-gray-500">Dịch Hai Chiều & Firebase AI Logic SDK</p>
        </header>

        <!-- Firebase Auth UI -->
        <div id="authContainer" class="auth-container mb-4">
            <h3 class="text-md font-semibold text-gray-700 mb-2 text-center">Xác Thực Firebase</h3>
            <div id="authForm" style="display: block;">
                <input type="email" id="emailInput" placeholder="Email" autocomplete="email">
                <input type="password" id="passwordInput" placeholder="Mật khẩu" autocomplete="current-password">
                <div class="flex justify-center space-x-2 mb-2">
                    <button id="registerButton" class="btn btn-primary">Đăng Ký</button>
                    <button id="loginButton" class="btn btn-primary">Đăng Nhập</button>
                </div>
            </div>
            <div id="userInfo" style="display: none;" class="text-center">
                <p id="userEmail" class="text-sm text-gray-700"></p>
                <button id="logoutButton" class="btn btn-secondary mt-1">Đăng Xuất</button>
            </div>
            <div id="authStatus" class="auth-status">Chưa đăng nhập.</div>
        </div>

        <!-- Language Selection -->
        <div class="language-select-container mb-4 p-4 rounded-lg">
            <div class="flex items-center justify-around space-x-2">
                <div class="language-select text-center">
                    <label for="sourceLangSelect" class="block text-sm font-medium text-gray-700 mb-1">Nói bằng:</label>
                    <select id="sourceLangSelect" class="btn">
                        <option value="en-US">Tiếng Anh</option>
                        <option value="vi-VN">Tiếng Việt</option>
                    </select>
                </div>
                <button id="swapLangButton" class="btn btn-secondary btn-icon" title="Đảo chiều ngôn ngữ">
                    <i class="fas fa-exchange-alt"></i>
                </button>
                <div class="language-select text-center">
                    <label for="targetLangSelect" class="block text-sm font-medium text-gray-700 mb-1">Dịch sang:</label>
                    <select id="targetLangSelect" class="btn">
                        <option value="vi">Tiếng Việt</option>
                        <option value="en">Tiếng Anh</option>
                    </select>
                </div>
            </div>
        </div>


        <div id="permissionNotice" class="permission-notice" style="display: none;">
            Ứng dụng này cần quyền truy cập microphone để hoạt động. Vui lòng cấp quyền khi được trình duyệt yêu cầu.
        </div>

        <div class="mb-4 text-center">
            <button id="startButton" class="btn btn-start mr-2">
                <span id="statusDot" class="status-dot status-idle"></span>Bắt đầu
            </button>
            <button id="stopButton" class="btn btn-stop" disabled>Dừng</button>
        </div>

        <!-- Raw Transcript Box -->
        <div class="raw-transcript-container transcript-box-container mb-4">
            <h2 class="text-md font-semibold text-gray-700 mb-1">Lời nói được ghi nhận (Thô):</h2>
            <div id="rawTranscriptBox" class="transcript-box"></div>
            <button id="clearRawTranscriptBtn" class="transcript-action-btn" title="Xóa lời nói thô"><i class="fas fa-times-circle"></i></button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="transcript-box-container">
                <h2 id="originalTextLabel" class="text-md font-semibold text-gray-700 mb-1">Chuẩn bị dịch:</h2>
                <div id="originalText" class="transcript-box"></div>
                <button id="clearOriginalTextBtn" class="transcript-action-btn" title="Xóa văn bản chuẩn bị dịch"><i class="fas fa-times-circle"></i></button>
            </div>
            <div class="transcript-box-container">
                <h2 id="translatedTextLabel" class="text-md font-semibold text-gray-700 mb-1">Dịch (Tiếng Việt):</h2>
                <div id="translatedText" class="transcript-box"></div>
                <button id="copyTranslatedTextBtn" class="transcript-action-btn" title="Sao chép bản dịch" style="right: 30px;"><i class="fas fa-copy"></i></button>
                <button id="clearTranslatedTextBtn" class="transcript-action-btn" title="Xóa bản dịch"><i class="fas fa-times-circle"></i></button>
            </div>
        </div>
         <div class="text-center mb-4">
            <button id="saveTranslationButton" class="btn btn-primary" style="display: none;">Lưu Bản Dịch Này</button>
        </div>

        <!-- Translation History -->
        <div id="historyContainer" class="history-container" style="display: none;">
            <h3 class="text-md font-semibold text-gray-700 mb-2 text-center">Lịch Sử Dịch</h3>
            <div id="translationHistory" class="space-y-2">
                <p class="text-center text-gray-500 text-sm">Chưa có lịch sử nào.</p>
            </div>
        </div>

        <div class="text-xs text-gray-400 text-center mt-4">
            Lưu ý: Nhận dạng giọng nói hoạt động tốt nhất trên Google Chrome.
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // DOM Element Constants
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const rawTranscriptBox = document.getElementById('rawTranscriptBox'); 
        const originalTextBox = document.getElementById('originalText'); 
        const translatedTextBox = document.getElementById('translatedText');
        const statusDot = document.getElementById('statusDot');
        const messageBox = document.getElementById('messageBox');
        const permissionNotice = document.getElementById('permissionNotice');
        const saveTranslationButton = document.getElementById('saveTranslationButton');
        
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const registerButton = document.getElementById('registerButton');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const authForm = document.getElementById('authForm');
        const userInfo = document.getElementById('userInfo');
        const userEmailDisplay = document.getElementById('userEmail');
        const authStatus = document.getElementById('authStatus');

        const historyContainer = document.getElementById('historyContainer');
        const translationHistoryDiv = document.getElementById('translationHistory');

        const sourceLangSelect = document.getElementById('sourceLangSelect');
        const targetLangSelect = document.getElementById('targetLangSelect');
        const swapLangButton = document.getElementById('swapLangButton');
        const originalTextLabel = document.getElementById('originalTextLabel'); 
        const translatedTextLabel = document.getElementById('translatedTextLabel');

        const clearOriginalTextBtn = document.getElementById('clearOriginalTextBtn');
        const clearTranslatedTextBtn = document.getElementById('clearTranslatedTextBtn');
        const copyTranslatedTextBtn = document.getElementById('copyTranslatedTextBtn');
        const clearRawTranscriptBtn = document.getElementById('clearRawTranscriptBtn');


        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc,
            query, 
            where, 
            orderBy, 
            limit, 
            getDocs, 
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { 
            getAI, 
            getGenerativeModel, 
            GoogleAIBackend 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-ai.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDRS3wkou1M7RjCqBdBwTmNkvcCzGANgxA", 
            authDomain: "cardnew-bfbce.firebaseapp.com",
            projectId: "cardnew-bfbce",
            storageBucket: "cardnew-bfbce.firebasestorage.app",
            messagingSenderId: "110225482882",
            appId: "1:110225482882:web:c3cdb03d508436ff17c09b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Initialize Firebase AI Logic
        let firebaseAIService;
        let generativeAIModel;

        function showUIMessage(message, duration = 3000) { 
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, duration);
            } else {
                console.warn("messageBox is not available yet for:", message);
            }
        }

        try {
            firebaseAIService = getAI(app, { backend: new GoogleAIBackend() });
            generativeAIModel = getGenerativeModel(firebaseAIService, { model: "gemini-2.0-flash" }); 
            console.log("Firebase AI Logic initialized with gemini-2.0-flash model.");
            showUIMessage("Dịch vụ AI đã sẵn sàng!", 2000);
        } catch (error) {
            console.error("Lỗi khởi tạo Firebase AI Logic:", error);
            showUIMessage("Lỗi khởi tạo dịch vụ AI: " + error.message, 7000);
            if (startButton) startButton.disabled = true; 
        }

        // Language mapping for display and API
        const languageMap = {
            "en-US": { name: "Tiếng Anh", geminiName: "English" },
            "vi-VN": { name: "Tiếng Việt", geminiName: "Vietnamese" },
            "en": { name: "Tiếng Anh", geminiName: "English" }, 
            "vi": { name: "Tiếng Việt", geminiName: "Vietnamese" } 
        };

        function updateLanguageLabels() {
            const sourceLangValue = sourceLangSelect.value;
            const targetLangValue = targetLangSelect.value;
            originalTextLabel.textContent = `Chuẩn bị dịch (${languageMap[sourceLangValue]?.name || sourceLangValue}):`;
            translatedTextLabel.textContent = `Dịch (${languageMap[targetLangValue]?.name || targetLangValue}):`;
        }


        // Speech Recognition & Translation
        let recognition;
        let isRecording = false;
        const USER_PAUSE_TIMEOUT = 1500; 
        let userPauseTimer; 
        
        let currentUtterance = ""; // To store the evolving transcript of the current speech
        let lastQueuedSegment = ""; // To prevent re-queuing the exact same segment


        // --- Translation Queue ---
        let translationQueue = [];
        let isProcessingQueue = false;

        async function processTranslationQueue() {
            if (isProcessingQueue || translationQueue.length === 0) {
                return;
            }
            isProcessingQueue = true;
            console.log(`Processing queue, ${translationQueue.length} items remaining.`);

            const item = translationQueue.shift(); 
            try {
                if (item) {
                    if(originalTextBox) { 
                        const p = document.createElement('p');
                        p.textContent = item.segmentToTranslate; 
                        originalTextBox.innerHTML = ''; 
                        originalTextBox.appendChild(p);
                        originalTextBox.scrollTop = originalTextBox.scrollHeight;
                    }
                    await sendToTranslateWithFirebaseAI(item.segmentToTranslate, item.placeholderId);
                }
            } catch (error) {
                console.error("Critical error processing translation queue item:", error, item);
                showUIMessage("Lỗi nghiêm trọng khi xử lý hàng đợi dịch.", 5000);
            } finally {
                isProcessingQueue = false;
            }
            
            if (translationQueue.length > 0) {
                setTimeout(processTranslationQueue, 50); 
            } else {
                console.log("Translation queue processed completely.");
            }
        }
        // --- End Translation Queue ---

        // --- Forced Segmentation Timer ---
        let maxUtteranceLengthTimer; 
        const MAX_UTTERANCE_LENGTH_MS = 4000; 
        // --- End Forced Segmentation Timer ---


        function initializeSpeechRecognition() {
            if (recognition) { 
                recognition.stop();
            }
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                if (generativeAIModel && permissionNotice) permissionNotice.style.display = 'block'; 
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true; 
                recognition.interimResults = true; 
                recognition.lang = sourceLangSelect.value; 

                recognition.onstart = () => {
                    isRecording = true;
                    startButton.disabled = true;
                    stopButton.disabled = false;
                    statusDot.classList.remove('status-idle');
                    statusDot.classList.add('status-recording');
                    startButton.childNodes[2].nodeValue = ' Đang ghi...';
                    showUIMessage("Bắt đầu ghi âm...");
                    if (permissionNotice) permissionNotice.style.display = 'none';
                    if (saveTranslationButton) saveTranslationButton.style.display = 'none'; 
                    
                    currentUtterance = "";
                    lastQueuedSegment = "";
                    if (rawTranscriptBox) rawTranscriptBox.innerHTML = ""; 
                    if (originalTextBox) originalTextBox.innerHTML = "";
                    if (translatedTextBox) translatedTextBox.innerHTML = "";
                    translationQueue = []; 
                    
                    clearTimeout(maxUtteranceLengthTimer); 
                    maxUtteranceLengthTimer = setTimeout(finalizeAndQueueCurrentUtterance, MAX_UTTERANCE_LENGTH_MS);
                };

                recognition.onresult = (event) => {
                    clearTimeout(userPauseTimer); 
                    clearTimeout(maxUtteranceLengthTimer);
                    maxUtteranceLengthTimer = setTimeout(finalizeAndQueueCurrentUtterance, MAX_UTTERANCE_LENGTH_MS);

                    let interim = "";
                    let finalTranscriptFromEvent = "";
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        const transcriptPart = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscriptFromEvent += transcriptPart;
                        } else {
                            interim += transcriptPart;
                        }
                    }

                    if (finalTranscriptFromEvent) {
                        currentUtterance += finalTranscriptFromEvent; // Append final part to current utterance
                        if (rawTranscriptBox) { // Update raw box with the new final part
                            rawTranscriptBox.innerHTML = currentUtterance.replace(/\n/g, "<br>");
                            rawTranscriptBox.scrollTop = rawTranscriptBox.scrollHeight;
                        }
                        finalizeAndQueueSegment(currentUtterance); // Try to queue the updated currentUtterance
                        currentUtterance = ""; // Reset currentUtterance after a final part is processed
                    } else if (interim) {
                        if (rawTranscriptBox) { // Update raw box with current utterance + new interim
                            rawTranscriptBox.innerHTML = (currentUtterance + interim).replace(/\n/g, "<br>");
                            rawTranscriptBox.scrollTop = rawTranscriptBox.scrollHeight;
                        }
                        // Set user pause timer only if there's new interim
                        userPauseTimer = setTimeout(() => {
                            if (isRecording && (currentUtterance + interim).trim()) {
                                console.log("User pause, finalizing:", (currentUtterance + interim).trim());
                                finalizeAndQueueSegment((currentUtterance + interim).trim());
                                currentUtterance = ""; // Reset
                            }
                        }, USER_PAUSE_TIMEOUT);
                    }
                };
                

                recognition.onerror = (event) => {
                    console.error("Speech recognition error:", event.error, event.message);
                    clearTimeout(maxUtteranceLengthTimer);
                    clearTimeout(userPauseTimer);
                    stopSpeechRecognition(); 
                };

                recognition.onend = () => {
                    clearTimeout(maxUtteranceLengthTimer);
                    clearTimeout(userPauseTimer);
                    if (isRecording) { 
                        console.log("Speech recognition ended.");
                        if (currentUtterance.trim()) { // Process any remaining utterance
                            finalizeAndQueueSegment(currentUtterance.trim());
                        }
                        processTranslationQueue(); 
                    } else {
                        console.log("Speech recognition ended by user.");
                    }
                    
                    isRecording = false; 
                    if (startButton && startButton.disabled) {
                        startButton.disabled = false;
                        if (stopButton) stopButton.disabled = true;
                        if (statusDot) {
                            statusDot.classList.remove('status-recording');
                            statusDot.classList.add('status-idle');
                        }
                        if (startButton.childNodes[2]) startButton.childNodes[2].nodeValue = ' Bắt đầu';
                    }
                };
            } else {
                 // ... (browser not supported) ...
            }
        }
        
        function finalizeAndQueueSegment(segmentText) {
            const trimmedSegment = segmentText.trim();
            if (!trimmedSegment || trimmedSegment === lastQueuedSegment) { // Avoid empty or duplicate segments
                if (trimmedSegment === lastQueuedSegment) console.log("Skipping duplicate segment for queue:", trimmedSegment);
                return;
            }

            console.log("Finalizing and queuing segment:", trimmedSegment);
            lastQueuedSegment = trimmedSegment; // Update last queued segment

            // Display in "Chuẩn bị dịch" box
            if (originalTextBox) {
                const p = document.createElement('p');
                p.textContent = trimmedSegment;
                originalTextBox.innerHTML = ''; // Show only this segment
                originalTextBox.appendChild(p);
                originalTextBox.scrollTop = originalTextBox.scrollHeight;
            }

            const placeholderId = `translating-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
            translationQueue.push({ 
                segmentToTranslate: trimmedSegment, 
                // fullOriginalTextForSave will be built from all successfully translated segments
                placeholderId: placeholderId 
            });
            processTranslationQueue(); 

            // Reset max utterance timer as a segment has been finalized and queued
            clearTimeout(maxUtteranceLengthTimer);
            if (isRecording) { 
                maxUtteranceLengthTimer = setTimeout(finalizeAndQueueCurrentUtterance, MAX_UTTERANCE_LENGTH_MS);
            }
        }
        
        function finalizeAndQueueCurrentUtterance() { // Called by maxUtteranceLengthTimer
            if (!isRecording) return;
            const segmentToFinalize = currentUtterance.trim();
            if (segmentToFinalize) {
                console.log("Max utterance timer, finalizing:", segmentToFinalize);
                finalizeAndQueueSegment(segmentToFinalize);
                currentUtterance = ""; // Reset after finalizing
            }
            // Timer will be reset within finalizeAndQueueSegment if still recording
        }
        
        // Initial setup
        updateLanguageLabels();
        initializeSpeechRecognition(); 

        sourceLangSelect.addEventListener('change', () => {
            updateLanguageLabels();
            initializeSpeechRecognition(); 
            if (isRecording) stopSpeechRecognition(); 
            showUIMessage(`Ngôn ngữ nói đổi thành: ${languageMap[sourceLangSelect.value]?.name}`, 2000);
        });

        targetLangSelect.addEventListener('change', () => {
            updateLanguageLabels();
            showUIMessage(`Ngôn ngữ dịch đổi thành: ${languageMap[targetLangSelect.value]?.name}`, 2000);
        });

        swapLangButton.addEventListener('click', () => {
            const currentSource = sourceLangSelect.value;
            const currentTarget = targetLangSelect.value;
            
            if (currentSource === "en-US" && currentTarget === "vi") {
                sourceLangSelect.value = "vi-VN";
                targetLangSelect.value = "en";
            } else if (currentSource === "vi-VN" && currentTarget === "en") {
                sourceLangSelect.value = "en-US";
                targetLangSelect.value = "vi";
            }
            
            updateLanguageLabels();
            initializeSpeechRecognition();
            if (isRecording) stopSpeechRecognition();
            showUIMessage("Đã đảo chiều ngôn ngữ.", 2000);
        });


        if (startButton) {
            startButton.addEventListener('click', () => {
                if (!generativeAIModel) {
                     showUIMessage("Dịch vụ AI chưa sẵn sàng. Vui lòng kiểm tra console để biết lỗi.", 5000);
                     return;
                }
                if (recognition) {
                    if (rawTranscriptBox) rawTranscriptBox.innerHTML = '';
                    if (originalTextBox) originalTextBox.innerHTML = ''; 
                    if (translatedTextBox) translatedTextBox.innerHTML = ''; 
                    currentUtterance = ""; 
                    lastQueuedSegment = "";
                    currentOriginalForSave = ""; 
                    currentTranslatedForSave = ""; 
                    translationQueue = []; 
                    try {
                        recognition.lang = sourceLangSelect.value; 
                        recognition.start(); 
                    } catch (e) {
                        console.error("Error starting recognition:", e);
                        if (e.name === 'InvalidStateError' && isRecording) {
                            showUIMessage("Ghi âm đã được bắt đầu.", 2000);
                        } else {
                            showUIMessage("Không thể bắt đầu ghi âm. Lỗi: " + e.message, 5000);
                            stopSpeechRecognition();
                        }
                    }
                }
            });
        }

        if (stopButton) {
            stopButton.addEventListener('click', () => {
                stopSpeechRecognition(); 
                if (currentUtterance.trim()) { // Finalize any remaining utterance
                    finalizeAndQueueSegment(currentUtterance.trim());
                }
                processTranslationQueue(); 
                showUIMessage("Đã dừng ghi âm.", 2000);
            });
        }

        function stopSpeechRecognition() { 
            clearTimeout(maxUtteranceLengthTimer); 
            clearTimeout(userPauseTimer);
            if (recognition && isRecording) {
                recognition.stop(); 
            }
            isRecording = false; 
        }
        
        let currentOriginalForSave = ""; // Accumulates successfully translated original segments
        let currentTranslatedForSave = ""; // Accumulates successful translations

        async function sendToTranslateWithFirebaseAI(textSegment, placeholderId) {
            if (!textSegment || textSegment.trim() === '') {
                 const el = document.getElementById(placeholderId);
                 if(el) el.remove(); 
                 return;
            }
            if (!generativeAIModel) {
                showUIMessage("Lỗi: Dịch vụ AI chưa sẵn sàng để dịch.", 5000);
                const errorP = document.getElementById(placeholderId);
                if (errorP) errorP.innerHTML = `<span class="text-red-500">[Lỗi AI Service]</span>`;
                return;
            }
            
            const targetElement = document.getElementById(placeholderId); 
            if (targetElement) { 
                 targetElement.innerHTML = `<span class="text-gray-400">Đang dịch: "${textSegment}"<span class="spinner"></span></span>`;
            } else { 
                const tempP = document.createElement('p');
                tempP.id = placeholderId; 
                tempP.innerHTML = `<span class="text-gray-400">Đang dịch: "${textSegment}"<span class="spinner"></span></span>`;
                if (translatedTextBox) translatedTextBox.insertBefore(tempP, translatedTextBox.firstChild);
            }

            try {
                const sourceLangForPrompt = languageMap[sourceLangSelect.value]?.geminiName || "auto";
                const targetLangForPrompt = languageMap[targetLangSelect.value]?.geminiName || "Vietnamese";
                
                const prompt = `Provide a direct translation of the following ${sourceLangForPrompt} text to ${targetLangForPrompt}, without explanations or additional context: "${textSegment}"`;
                
                console.log("Sending prompt to Gemini:", prompt);
                
                const streamResult = await generativeAIModel.generateContentStream(prompt);

                let accumulatedTranslatedTextForSegment = "";
                let firstChunk = true;
                const liveTargetElement = document.getElementById(placeholderId); 

                for await (const item of streamResult.stream) {
                    const chunkText = item.text();
                    console.log("Stream chunk:", chunkText);
                    accumulatedTranslatedTextForSegment += chunkText;
                    
                    if (liveTargetElement) {
                        if (firstChunk) {
                            liveTargetElement.innerHTML = `<span class="text-sm font-semibold text-blue-600">${chunkText.trim()}</span>`;
                            firstChunk = false;
                        } else {
                            liveTargetElement.querySelector('span.text-blue-600').textContent += chunkText;
                        }
                    } 
                }
                
                // Update for saving - Prepend to keep chronological order (newest on top in display)
                if (accumulatedTranslatedTextForSegment.trim()) {
                    currentOriginalForSave = textSegment + (currentOriginalForSave ? "\n" + currentOriginalForSave : "");
                    currentTranslatedForSave = accumulatedTranslatedTextForSegment.trim() + (currentTranslatedForSave ? "\n" + currentTranslatedForSave : ""); 
                }


                if(auth.currentUser && saveTranslationButton && currentOriginalForSave.trim() !== "" && currentTranslatedForSave.trim() !== "") {
                    saveTranslationButton.style.display = 'inline-block';
                }
                if (accumulatedTranslatedTextForSegment.trim() === "" && liveTargetElement) { 
                     liveTargetElement.innerHTML = `<span class="text-red-500">[Không nhận được bản dịch]</span>`;
                }

            } catch (error) {
                console.error("Lỗi khi dịch (Firebase AI Logic Stream):", error);
                showUIMessage("Lỗi khi dịch (AI Stream): " + error.message, 7000);
                const errorTargetElement = document.getElementById(placeholderId);
                if (errorTargetElement) {
                    errorTargetElement.innerHTML = `<span class="text-red-500">[Lỗi dịch (AI Stream): ${error.message}]</span>`;
                } 
            }
        }

        // --- UI Action Buttons ---
        if(clearOriginalTextBtn) {
            clearOriginalTextBtn.addEventListener('click', () => {
                if(originalTextBox) originalTextBox.innerHTML = '';
                // currentOriginalForSave should be cleared if user clears the staging box
                // but this might be complex if queue is still processing.
                // For now, this only clears the display.
                showUIMessage("Đã xóa văn bản chuẩn bị dịch.", 1500);
            });
        }
         if(clearRawTranscriptBtn) { 
            clearRawTranscriptBtn.addEventListener('click', () => {
                if(rawTranscriptBox) rawTranscriptBox.innerHTML = '';
                currentUtterance = ""; 
                lastQueuedSegment = "";
                showUIMessage("Đã xóa lời nói thô.", 1500);
            });
        }


        if(clearTranslatedTextBtn) {
            clearTranslatedTextBtn.addEventListener('click', () => {
                if(translatedTextBox) translatedTextBox.innerHTML = '';
                currentTranslatedForSave = ""; // Clear for save
                if(saveTranslationButton) saveTranslationButton.style.display = 'none';
                showUIMessage("Đã xóa bản dịch.", 1500);
            });
        }

        if(copyTranslatedTextBtn) {
            copyTranslatedTextBtn.addEventListener('click', () => {
                if(translatedTextBox && translatedTextBox.textContent.trim() !== "") {
                    const textToCopy = Array.from(translatedTextBox.querySelectorAll('p span.text-blue-600'))
                                                .map(span => span.textContent.trim())
                                                .join('\n'); 

                        if (textToCopy) {
                            navigator.clipboard.writeText(textToCopy)
                                .then(() => showUIMessage("Đã sao chép bản dịch!", 1500))
                                .catch(err => {
                                    console.error('Lỗi sao chép: ', err);
                                    try {
                                        const textArea = document.createElement("textarea");
                                        textArea.value = textToCopy;
                                        document.body.appendChild(textArea);
                                        textArea.focus();
                                        textArea.select();
                                        document.execCommand('copy');
                                        document.body.removeChild(textArea);
                                        showUIMessage("Đã sao chép bản dịch! (fallback)", 1500);
                                    } catch (fallbackErr) {
                                        console.error('Lỗi sao chép (fallback): ', fallbackErr);
                                        showUIMessage("Lỗi khi sao chép.", 2000);
                                    }
                                });
                        } else {
                             showUIMessage("Không có nội dung dịch để sao chép.", 1500);
                        }
                } else {
                    showUIMessage("Không có gì để sao chép.", 1500);
                }
            });
        }


        // Firebase Auth
        if (registerButton) { /* ... (Auth code as before) ... */ }
        if (loginButton) { /* ... (Auth code as before) ... */ }
        if (logoutButton) { /* ... (Auth code as before) ... */ }
        
        let unsubscribeHistory = null; 
        onAuthStateChanged(auth, (user) => { /* ... (Auth state change as before) ... */ });

        // Firestore - Save Translation
        if (saveTranslationButton) { /* ... (Save to Firestore as before, using currentOriginalForSave and currentTranslatedForSave) ... */ }

        // Firestore - Load Translation History
        async function loadTranslationHistory(userId) { /* ... (Load history as before) ... */ }
    </script>
</body>
</html>
