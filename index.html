<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Lab MVP - Visual Solution Simulation</title>
    <!-- Thêm thư viện Konva.js -->
    <script src="https://unpkg.com/konva@9.3.6/konva.min.js"></script>
    <!-- Thêm Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: sans-serif; 
        }
        #konva-stage-container canvas { 
            max-width: 100%; 
            height: auto !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">
    <h1 class="text-2xl md:text-3xl font-bold text-blue-700 text-center mb-6">Phòng Thí Nghiệm Mô Phỏng AI (MVP)</h1>

    <div id="lab-container" class="flex flex-col md:flex-row md:justify-around w-full max-w-6xl mx-auto gap-4">
        
        <div id="konva-outer-container" class="w-full md:w-2/3 bg-gray-200 border border-gray-300 rounded-lg shadow p-2 flex justify-center items-center">
            <div id="konva-stage-container"></div>
        </div>

        <div id="ai-controls-container" class="w-full md:w-1/3 flex flex-col bg-white p-4 border border-gray-300 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-blue-600 mb-3">Kết quả & Tương tác AI</h2>
            
            <h3 class="text-lg font-semibold text-blue-600 mb-2">Phản hồi từ Gemini:</h3>
            <div id="responseContainer" class="p-3 border border-gray-200 bg-gray-50 rounded-md min-h-[150px] whitespace-pre-wrap flex-grow overflow-y-auto mb-4">
                Chưa có phản hồi...
            </div>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">Gửi lời nhắc thủ công:</h3>
            <div id="controls" class="flex flex-col">
                <textarea id="promptInput" rows="3" placeholder="Nhập lời nhắc thủ công ở đây..." class="w-full p-2 border border-gray-300 rounded-md mb-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                <button id="sendPromptButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Gửi tới Gemini</button>
            </div>
            <button id="resetBeakerButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 mt-4">Làm sạch cốc</button>
        </div>
    </div>

    <script type="module">
      // --- PHẦN KHỞI TẠO FIREBASE VÀ GEMINI API (Giữ nguyên) ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
      import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-ai.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAnWoc5pBabK2OfFeCau61X1PioBR5gBD8", // **QUAN TRỌNG: Thay bằng API key của bạn**
        authDomain: "ailab-9ef87.firebaseapp.com",
        projectId: "ailab-9ef87",
        storageBucket: "ailab-9ef87.appspot.com",
        messagingSenderId: "558122624068",
        appId: "1:558122624068:web:bde003000c6568f5e74811"
      };

      const app = initializeApp(firebaseConfig);
      console.log("Firebase App initialized!");
      
      let geminiModel;
      try {
        const ai = getAI(app, { backend: new GoogleAIBackend() });
        geminiModel = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
        console.log("Generative Model instance created with model 'gemini-1.5-flash-latest'!");
        if(document.getElementById("responseContainer")) {
            document.getElementById("responseContainer").innerHTML = "Firebase & AI Model đã sẵn sàng.<br>Kéo thả hóa chất để bắt đầu thí nghiệm hoặc gửi lời nhắc thủ công.";
        }
      } catch (e) {
        console.error("Lỗi khi khởi tạo AI Model:", e);
        if(document.getElementById("responseContainer")) {
             document.getElementById("responseContainer").innerHTML = `<span class="text-red-600 font-bold">Lỗi khởi tạo AI Model: ${e.message}.</span>`;
        }
      }
      
      async function callGeminiAPI(promptText) {
        const responseContainer = document.getElementById("responseContainer");
        if (!geminiModel) {
          if(responseContainer) {
            responseContainer.innerText = "Mô hình AI chưa được khởi tạo.";
          }
          return "Lỗi: Mô hình AI chưa được khởi tạo.";
        }
        if (!promptText || !promptText.trim()) {
            if (document.activeElement && document.activeElement.id === 'sendPromptButton') {
                 alert("Vui lòng nhập lời nhắc!");
            }
            return "Lỗi: Lời nhắc trống.";
        }
        if(responseContainer) {
            responseContainer.innerText = "Đang gửi yêu cầu đến Gemini...";
        }
        console.log("Sending prompt to Gemini:", promptText);

        try {
          const result = await geminiModel.generateContent(promptText);
          const response = await result.response;
          const text = response.text();
          if(responseContainer) {
            responseContainer.innerText = text;
          }
          console.log("Response text from Gemini:", text);
          return text;
        } catch (error) {
          console.error("Lỗi khi gọi Gemini API:", error);
          if(responseContainer) {
            responseContainer.innerHTML = `<span class="text-red-600 font-bold">Lỗi khi gọi Gemini API: ${error.message}.</span>`;
          }
          return `Lỗi Gemini: ${error.message}`;
        }
      }
      
      const sendButton = document.getElementById("sendPromptButton");
      if (sendButton) {
          sendButton.addEventListener("click", () => {
              const promptText = document.getElementById("promptInput").value;
              callGeminiAPI(promptText);
          });
      }

      // --- PHẦN KONVA.JS ---
      const initialStageWidth = 600; 
      const initialStageHeight = 400;

      const konvaOuterContainer = document.getElementById('konva-outer-container');
      let currentStageWidth = Math.min(initialStageWidth, konvaOuterContainer.clientWidth > 20 ? konvaOuterContainer.clientWidth - 20 : initialStageWidth);
      let currentStageHeight = initialStageHeight; 

      if (currentStageWidth < initialStageWidth && konvaOuterContainer.clientWidth > 20) {
          currentStageHeight = (currentStageWidth / initialStageWidth) * initialStageHeight;
      }

      const stage = new Konva.Stage({
        container: 'konva-stage-container',
        width: currentStageWidth,
        height: currentStageHeight,
      });

      const layer = new Konva.Layer();
      stage.add(layer);

      let chemicalsInBeaker = []; 
      const MAX_LIQUID_LEVEL_RISE = 40; // Số pixel tối đa mực nước có thể dâng lên (giá trị gốc)

      function getResponsiveValue(baseValue, baseStageWidth = initialStageWidth, currentDim = currentStageWidth) {
          if (baseStageWidth === 0) return baseValue;
          return (baseValue / baseStageWidth) * currentDim;
      }
      function getResponsiveSize(baseWidth, baseHeight, baseStageWidth = initialStageWidth, baseStageHeight = initialStageHeight) {
          if (baseStageWidth === 0 || baseStageHeight === 0) return {width: baseWidth, height: baseHeight};
          const scaleWidth = currentStageWidth / baseStageWidth;
          const scaleHeight = currentStageWidth / baseStageWidth; 
          return {
              width: baseWidth * scaleWidth,
              height: baseHeight * scaleHeight 
          };
      }

      // Cốc thí nghiệm
      const beakerBaseX = initialStageWidth / 2 - 50;
      const beakerBaseY = initialStageHeight - 120;
      const beakerBaseSize = { width: 100, height: 100 };

      const beakerSize = getResponsiveSize(beakerBaseSize.width, beakerBaseSize.height);
      const beaker = new Konva.Rect({
        x: getResponsiveValue(beakerBaseX),
        y: getResponsiveValue(beakerBaseY, initialStageHeight, currentStageHeight), 
        width: beakerSize.width,
        height: beakerSize.height,
        fill: '#E0E0E0', // Màu cốc nhạt hơn một chút
        stroke: 'black',
        strokeWidth: Math.max(1, getResponsiveValue(2)),
        name: 'beaker'
      });
      layer.add(beaker);
      
      // **THAY ĐỔI: Thêm hình chữ nhật mô phỏng dung dịch trong cốc**
      const solutionPadding = getResponsiveValue(5); // Khoảng cách từ thành cốc
      const initialSolutionHeight = getResponsiveValue(10); // Chiều cao ban đầu của dung dịch (rất ít)
      
      const solution = new Konva.Rect({
          x: beaker.x() + solutionPadding,
          y: beaker.y() + beaker.height() - initialSolutionHeight - solutionPadding, // Bắt đầu từ đáy cốc
          width: beaker.width() - 2 * solutionPadding,
          height: initialSolutionHeight,
          fill: 'transparent', // Ban đầu trong suốt
          name: 'solution'
      });
      layer.add(solution);
      solution.moveToBottom(); // Đảm bảo dung dịch nằm dưới các nhãn nếu có
      beaker.moveToTop(); // Đảm bảo cốc nằm trên dung dịch (để thấy viền cốc)


      const beakerLabelFontSize = Math.max(10, getResponsiveValue(18));
      const beakerLabel = new Konva.Text({
        x: beaker.x() + beaker.width() / 2,
        y: beaker.y() + beaker.height() / 2,
        text: 'Cốc TN',
        fontSize: beakerLabelFontSize,
        fill: 'black',
      });
      beakerLabel.offsetX(beakerLabel.width() / 2);
      beakerLabel.offsetY(beakerLabel.height() / 2);
      layer.add(beakerLabel);
      beakerLabel.moveToTop(); // Nhãn cốc cũng nên ở trên

      // Dữ liệu hóa chất
      const chemicalsData = [
        { name: 'Axit HCl', x: 50, y: 50, color: 'rgba(255, 0, 0, 0.7)', id: 'hcl', baseWidth: 100, baseHeight: 50, solutionColor: 'pink' },
        { name: 'Bazơ NaOH', x: 50, y: 120, color: 'rgba(0, 0, 255, 0.7)', id: 'naoh', baseWidth: 100, baseHeight: 50, solutionColor: 'lightblue' },
        { name: 'Nước', x: 50, y: 190, color: 'rgba(173, 216, 230, 0.7)', id: 'water', baseWidth: 100, baseHeight: 50, solutionColor: 'rgba(200, 220, 255, 0.5)'}
      ];

      function getChemicalDataById(id) {
          return chemicalsData.find(c => c.id === id);
      }

      chemicalsData.forEach(data => {
        const chemicalSize = getResponsiveSize(data.baseWidth, data.baseHeight);
        const chemicalGroup = new Konva.Group({
            x: getResponsiveValue(data.x),
            y: getResponsiveValue(data.y, initialStageHeight, currentStageHeight),
            draggable: true,
            name: 'chemical',
            id: data.id
        });

        const rect = new Konva.Rect({
          width: chemicalSize.width,
          height: chemicalSize.height,
          fill: data.color, // Màu của khối hóa chất
          stroke: 'black',
          strokeWidth: Math.max(1, getResponsiveValue(2)),
          cornerRadius: getResponsiveValue(5)
        });
        chemicalGroup.add(rect);

        const labelFontSize = Math.max(8, getResponsiveValue(14));
        const label = new Konva.Text({
          text: data.name,
          fontSize: labelFontSize,
          fill: 'white',
          padding: getResponsiveValue(5),
          align: 'center',
          verticalAlign: 'middle',
          width: chemicalSize.width,
          height: chemicalSize.height
        });
        chemicalGroup.add(label);
        
        layer.add(chemicalGroup);
        chemicalGroup.setAttr('initialX', getResponsiveValue(data.x));
        chemicalGroup.setAttr('initialY', getResponsiveValue(data.y, initialStageHeight, currentStageHeight));

        chemicalGroup.on('dragend', function() {
          const droppedChemicalGroup = this;
          const droppedChemicalId = droppedChemicalGroup.id();
          const droppedChemicalData = getChemicalDataById(droppedChemicalId);
          
          console.log(`Thả ${droppedChemicalData.name}`);
          
          const beakerRect = beaker.getClientRect(); 
          const chemicalRect = droppedChemicalGroup.getClientRect();

          if (Konva.Util.haveIntersection(beakerRect, chemicalRect)) {
            console.log(`${droppedChemicalData.name} đã được thả vào cốc!`);
            
            // **THAY ĐỔI: Cập nhật dung dịch trong cốc**
            if (!chemicalsInBeaker.includes(droppedChemicalId)) {
                 chemicalsInBeaker.push(droppedChemicalId);
            }

            // Tính toán màu dung dịch mới (logic trộn màu đơn giản)
            let newSolutionColor = droppedChemicalData.solutionColor; // Mặc định là màu của hóa chất mới
            if (chemicalsInBeaker.length > 1) {
                // Ví dụ trộn màu: Nếu có HCl (pink) và NaOH (lightblue), có thể ra màu tím nhạt hoặc màu trung tính
                // Đây là một logic rất đơn giản, có thể cải thiện nhiều
                if (chemicalsInBeaker.includes('hcl') && chemicalsInBeaker.includes('naoh')) {
                    newSolutionColor = 'rgba(180, 150, 220, 0.6)'; // Màu tím nhạt ví dụ
                } else if (chemicalsInBeaker.length === 1 && chemicalsInBeaker[0] !== droppedChemicalId) {
                    // Nếu chỉ có 1 chất cũ, và chất mới khác, lấy màu chất mới
                     const firstChemical = getChemicalDataById(chemicalsInBeaker[0]);
                     if (firstChemical) newSolutionColor = firstChemical.solutionColor; // Ưu tiên màu chất đầu tiên nếu chỉ có 1
                }
            }
            solution.fill(newSolutionColor);

            // Tính toán chiều cao dung dịch mới
            const responsiveMaxRise = getResponsiveValue(MAX_LIQUID_LEVEL_RISE, initialStageHeight, currentStageHeight);
            const risePerChemical = responsiveMaxRise / chemicalsData.length; // Chia đều mức tăng
            let newSolutionHeight = initialSolutionHeight + Math.min(chemicalsInBeaker.length * risePerChemical, responsiveMaxRise);
            newSolutionHeight = Math.min(newSolutionHeight, beaker.height() - 2 * solutionPadding); // Không vượt quá chiều cao cốc

            // Animation cho mực nước dâng lên
            new Konva.Tween({
                node: solution,
                duration: 0.5, // Thời gian animation
                height: newSolutionHeight,
                y: beaker.y() + beaker.height() - newSolutionHeight - solutionPadding,
                easing: Konva.Easings.EaseInOut
            }).play();


            // Xây dựng prompt AI
            let experimentPrompt = "";
            const currentChemicalNamesInBeaker = chemicalsInBeaker.map(id => getChemicalDataById(id)?.name || id);

            if (chemicalsInBeaker.length === 1 && chemicalsInBeaker[0] === droppedChemicalId) { // Chỉ có 1 chất, là chất vừa thả
              experimentPrompt = `Giải thích hiện tượng khi cho ${droppedChemicalData.name} vào một cốc thí nghiệm rỗng.`;
            } else {
              // Lấy danh sách các chất đã có TRƯỚC KHI thêm chất mới (nếu cần)
              const previousChemicals = currentChemicalNamesInBeaker.filter(name => name !== droppedChemicalData.name);
              if (previousChemicals.length > 0) {
                experimentPrompt = `Trong một cốc thí nghiệm đang chứa ${previousChemicals.join(' và ')}. Bây giờ, thêm ${droppedChemicalData.name} vào hỗn hợp này. Giải thích các hiện tượng hóa học có thể xảy ra, bao gồm sự thay đổi màu sắc và các phản ứng khác.`;
              } else {
                 experimentPrompt = `Giải thích hiện tượng khi cho ${droppedChemicalData.name} vào một cốc thí nghiệm rỗng.`;
              }
            }
            
            console.log("Hóa chất trong cốc hiện tại:", currentChemicalNamesInBeaker);
            if (experimentPrompt) {
                callGeminiAPI(experimentPrompt);
            }

            setTimeout(() => {
                droppedChemicalGroup.position({ 
                    x: droppedChemicalGroup.getAttr('initialX'), 
                    y: droppedChemicalGroup.getAttr('initialY') 
                });
                layer.batchDraw();
            }, 1500);

          } else {
            console.log(`${droppedChemicalData.name} không được thả vào cốc.`);
          }
          layer.batchDraw();
        });
      });

      const resetBeakerButton = document.getElementById('resetBeakerButton');
      if (resetBeakerButton) {
          resetBeakerButton.addEventListener('click', () => {
              chemicalsInBeaker = []; 
              // Reset dung dịch
              solution.height(initialSolutionHeight);
              solution.y(beaker.y() + beaker.height() - initialSolutionHeight - solutionPadding);
              solution.fill('transparent');
              
              beaker.fill('#E0E0E0'); // Reset màu cốc
              layer.batchDraw();
              if(document.getElementById("responseContainer")){
                  document.getElementById("responseContainer").innerHTML = "Cốc đã được làm sạch. Sẵn sàng cho thí nghiệm mới!";
              }
              console.log("Cốc đã được làm sạch.");
          });
      }

      layer.draw();
      console.log("Konva.js initialized and objects drawn.");

      function fitStageIntoParentContainer() {
        const container = document.getElementById('konva-outer-container');
        if (!container) return;

        const containerPadding = 16; 
        let containerWidth = container.offsetWidth - containerPadding;
        if (containerWidth <=0) containerWidth = initialStageWidth; 

        let scale = containerWidth / initialStageWidth;
        scale = Math.max(scale, 0.3); 

        const newStageWidth = initialStageWidth * scale;
        const newStageHeight = initialStageHeight * scale;

        stage.width(newStageWidth);
        stage.height(newStageHeight);
        stage.scale({ x: scale, y: scale }); // Scale toàn bộ stage, bao gồm cả solution
        stage.draw();
      }

      window.addEventListener('load', fitStageIntoParentContainer);
      window.addEventListener('resize', fitStageIntoParentContainer);
      setTimeout(fitStageIntoParentContainer, 100);

    </script>
</body>
</html>
