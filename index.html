<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiên Dịch Thời Gian Thực - Hai Chiều</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .transcript-box-container {
            position: relative; /* For positioning clear/copy buttons */
        }
        .transcript-box {
            min-height: 80px; 
            border: 1px solid #d1d5db;
            padding: 10px;
            padding-right: 30px; /* Space for buttons */
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            overflow-y: auto; 
            max-height: 150px; 
        }
        .transcript-action-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #9ca3af; /* Light gray */
            cursor: pointer;
            font-size: 0.9rem;
            padding: 2px;
        }
        .transcript-action-btn:hover {
            color: #4b5563; /* Darker gray */
        }
        .btn {
            padding: 8px 16px; 
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.875rem; 
        }
        .btn-start { background-color: #2563eb; color: white; }
        .btn-start:hover { background-color: #1d4ed8; }
        .btn-stop { background-color: #dc2626; color: white; }
        .btn-stop:hover { background-color: #b91c1c; }
        .btn-primary { background-color: #16a34a; color: white; } 
        .btn-primary:hover { background-color: #15803d; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-icon { padding: 6px 10px; }


        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-recording { background-color: #ef4444; animation: pulse 1.5s infinite; }
        .status-idle { background-color: #6b7280; }
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.7; }
        }
        .message-box {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            max-width: 90%;
            text-align: center;
            font-size: 0.875rem;
        }
        .message-box.show { opacity: 1; }
        .permission-notice {
            background-color: #fffbeb; color: #92400e;
            padding: 8px; border-radius: 8px; border: 1px solid #fef3c7;
            margin-bottom: 0.75rem; text-align: center; font-size: 0.8rem;
        }
        .auth-form input, .language-select select {
            border: 1px solid #d1d5db; padding: 8px 10px; border-radius: 6px; margin-bottom: 0.5rem; width: 100%;
            font-size: 0.875rem;
        }
         .language-select select { width: auto; min-width: 120px;}
        .auth-container, .history-container, .language-select-container {
            border: 1px solid #e5e7eb; padding: 1rem; border-radius: 8px; margin-top: 1rem; background-color: #f9fafb;
        }
        .auth-status { font-size: 0.8rem; color: #4b5563; margin-top: 0.5rem; text-align: center; }
        .history-item {
            background-color: #ffffff;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        .history-item p { margin-bottom: 4px; }
        .history-item .original { color: #374151; }
        .history-item .translated { color: #1d4ed8; font-weight: 500; }
        .history-item .timestamp { font-size: 0.75rem; color: #6b7280; text-align: right; }
        #translationHistory { max-height: 200px; overflow-y: auto; }
        
        /* Spinner styles */
        .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
            vertical-align: text-bottom;
            margin-left: 5px;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-2 sm:p-4">

    <div class="w-full max-w-xl bg-white p-4 sm:p-6 rounded-xl shadow-xl">
        <header class="text-center mb-4">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Phiên Dịch Thời Gian Thực</h1>
            <p class="text-xs sm:text-sm text-gray-500">Dịch Hai Chiều & Firebase AI Logic SDK</p>
        </header>

        <!-- Firebase Auth UI -->
        <div id="authContainer" class="auth-container mb-4">
            <h3 class="text-md font-semibold text-gray-700 mb-2 text-center">Xác Thực Firebase</h3>
            <div id="authForm" style="display: block;">
                <input type="email" id="emailInput" placeholder="Email" autocomplete="email">
                <input type="password" id="passwordInput" placeholder="Mật khẩu" autocomplete="current-password">
                <div class="flex justify-center space-x-2 mb-2">
                    <button id="registerButton" class="btn btn-primary">Đăng Ký</button>
                    <button id="loginButton" class="btn btn-primary">Đăng Nhập</button>
                </div>
            </div>
            <div id="userInfo" style="display: none;" class="text-center">
                <p id="userEmail" class="text-sm text-gray-700"></p>
                <button id="logoutButton" class="btn btn-secondary mt-1">Đăng Xuất</button>
            </div>
            <div id="authStatus" class="auth-status">Chưa đăng nhập.</div>
        </div>

        <!-- Language Selection -->
        <div class="language-select-container mb-4 p-4 rounded-lg">
            <div class="flex items-center justify-around space-x-2">
                <div class="language-select text-center">
                    <label for="sourceLangSelect" class="block text-sm font-medium text-gray-700 mb-1">Nói bằng:</label>
                    <select id="sourceLangSelect" class="btn">
                        <option value="en-US">Tiếng Anh</option>
                        <option value="vi-VN">Tiếng Việt</option>
                    </select>
                </div>
                <button id="swapLangButton" class="btn btn-secondary btn-icon" title="Đảo chiều ngôn ngữ">
                    <i class="fas fa-exchange-alt"></i>
                </button>
                <div class="language-select text-center">
                    <label for="targetLangSelect" class="block text-sm font-medium text-gray-700 mb-1">Dịch sang:</label>
                    <select id="targetLangSelect" class="btn">
                        <option value="vi">Tiếng Việt</option>
                        <option value="en">Tiếng Anh</option>
                    </select>
                </div>
            </div>
        </div>


        <div id="permissionNotice" class="permission-notice" style="display: none;">
            Ứng dụng này cần quyền truy cập microphone để hoạt động. Vui lòng cấp quyền khi được trình duyệt yêu cầu.
        </div>

        <div class="mb-4 text-center">
            <button id="startButton" class="btn btn-start mr-2">
                <span id="statusDot" class="status-dot status-idle"></span>Bắt đầu
            </button>
            <button id="stopButton" class="btn btn-stop" disabled>Dừng</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="transcript-box-container">
                <h2 id="originalTextLabel" class="text-md font-semibold text-gray-700 mb-1">Bạn nói (Tiếng Anh):</h2>
                <div id="originalText" class="transcript-box"></div>
                <button id="clearOriginalTextBtn" class="transcript-action-btn" title="Xóa văn bản gốc"><i class="fas fa-times-circle"></i></button>
            </div>
            <div class="transcript-box-container">
                <h2 id="translatedTextLabel" class="text-md font-semibold text-gray-700 mb-1">Dịch (Tiếng Việt):</h2>
                <div id="translatedText" class="transcript-box"></div>
                <button id="copyTranslatedTextBtn" class="transcript-action-btn" title="Sao chép bản dịch" style="right: 30px;"><i class="fas fa-copy"></i></button>
                <button id="clearTranslatedTextBtn" class="transcript-action-btn" title="Xóa bản dịch"><i class="fas fa-times-circle"></i></button>
            </div>
        </div>
         <div class="text-center mb-4">
            <button id="saveTranslationButton" class="btn btn-primary" style="display: none;">Lưu Bản Dịch Này</button>
        </div>

        <!-- Translation History -->
        <div id="historyContainer" class="history-container" style="display: none;">
            <h3 class="text-md font-semibold text-gray-700 mb-2 text-center">Lịch Sử Dịch</h3>
            <div id="translationHistory" class="space-y-2">
                <p class="text-center text-gray-500 text-sm">Chưa có lịch sử nào.</p>
            </div>
        </div>

        <div class="text-xs text-gray-400 text-center mt-4">
            Lưu ý: Nhận dạng giọng nói hoạt động tốt nhất trên Google Chrome.
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // DOM Element Constants
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const originalTextBox = document.getElementById('originalText');
        const translatedTextBox = document.getElementById('translatedText');
        const statusDot = document.getElementById('statusDot');
        const messageBox = document.getElementById('messageBox');
        const permissionNotice = document.getElementById('permissionNotice');
        const saveTranslationButton = document.getElementById('saveTranslationButton');
        
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const registerButton = document.getElementById('registerButton');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const authForm = document.getElementById('authForm');
        const userInfo = document.getElementById('userInfo');
        const userEmailDisplay = document.getElementById('userEmail');
        const authStatus = document.getElementById('authStatus');

        const historyContainer = document.getElementById('historyContainer');
        const translationHistoryDiv = document.getElementById('translationHistory');

        const sourceLangSelect = document.getElementById('sourceLangSelect');
        const targetLangSelect = document.getElementById('targetLangSelect');
        const swapLangButton = document.getElementById('swapLangButton');
        const originalTextLabel = document.getElementById('originalTextLabel');
        const translatedTextLabel = document.getElementById('translatedTextLabel');

        const clearOriginalTextBtn = document.getElementById('clearOriginalTextBtn');
        const clearTranslatedTextBtn = document.getElementById('clearTranslatedTextBtn');
        const copyTranslatedTextBtn = document.getElementById('copyTranslatedTextBtn');

        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc,
            query, 
            where, 
            orderBy, 
            limit, 
            getDocs, 
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { 
            getAI, 
            getGenerativeModel, 
            GoogleAIBackend 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-ai.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDRS3wkou1M7RjCqBdBwTmNkvcCzGANgxA", 
            authDomain: "cardnew-bfbce.firebaseapp.com",
            projectId: "cardnew-bfbce",
            storageBucket: "cardnew-bfbce.firebasestorage.app",
            messagingSenderId: "110225482882",
            appId: "1:110225482882:web:c3cdb03d508436ff17c09b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Initialize Firebase AI Logic
        let firebaseAIService;
        let generativeAIModel;

        function showUIMessage(message, duration = 3000) { 
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, duration);
            } else {
                console.warn("messageBox is not available yet for:", message);
            }
        }

        try {
            firebaseAIService = getAI(app, { backend: new GoogleAIBackend() });
            generativeAIModel = getGenerativeModel(firebaseAIService, { model: "gemini-2.0-flash" }); 
            console.log("Firebase AI Logic initialized with gemini-2.0-flash model.");
            showUIMessage("Dịch vụ AI đã sẵn sàng!", 2000);
        } catch (error) {
            console.error("Lỗi khởi tạo Firebase AI Logic:", error);
            showUIMessage("Lỗi khởi tạo dịch vụ AI: " + error.message, 7000);
            if (startButton) startButton.disabled = true; 
        }

        // Language mapping for display and API
        const languageMap = {
            "en-US": { name: "Tiếng Anh", geminiName: "English" },
            "vi-VN": { name: "Tiếng Việt", geminiName: "Vietnamese" },
            "en": { name: "Tiếng Anh", geminiName: "English" }, 
            "vi": { name: "Tiếng Việt", geminiName: "Vietnamese" } 
        };

        function updateLanguageLabels() {
            const sourceLangValue = sourceLangSelect.value;
            const targetLangValue = targetLangSelect.value;
            originalTextLabel.textContent = `Bạn nói (${languageMap[sourceLangValue]?.name || sourceLangValue}):`;
            translatedTextLabel.textContent = `Dịch (${languageMap[targetLangValue]?.name || targetLangValue}):`;
        }


        // Speech Recognition & Translation
        let recognition;
        let isRecording = false;
        const FINAL_TRANSCRIPT_TIMEOUT = 1000; 
        let finalTranscriptTimer;
        let lastFinalTranscript = ""; 

        // --- Translation Queue ---
        let translationQueue = [];
        let isProcessingQueue = false;

        async function processTranslationQueue() {
            if (isProcessingQueue || translationQueue.length === 0) {
                return;
            }
            isProcessingQueue = true;
            // Optional: UI indicator for queue processing
            // console.log(`Processing queue, ${translationQueue.length} items remaining.`);

            const item = translationQueue.shift(); 
            try {
                if (item) {
                    await sendToTranslateWithFirebaseAI(item.segment, item.fullText, item.placeholderId);
                }
            } catch (error) {
                // This catch is for unexpected errors within the queue processing logic itself,
                // sendToTranslateWithFirebaseAI has its own error handling for API calls.
                console.error("Critical error processing translation queue item:", error, item);
                showUIMessage("Lỗi nghiêm trọng khi xử lý hàng đợi dịch.", 5000);
            } finally {
                isProcessingQueue = false;
            }
            
            if (translationQueue.length > 0) {
                setTimeout(processTranslationQueue, 50); // Give browser a bit more time
            } else {
                console.log("Translation queue processed completely.");
            }
        }
        // --- End Translation Queue ---


        function initializeSpeechRecognition() {
            if (recognition) { 
                recognition.stop();
            }
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                if (generativeAIModel && permissionNotice) permissionNotice.style.display = 'block'; 
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = sourceLangSelect.value; 

                recognition.onstart = () => {
                    isRecording = true;
                    startButton.disabled = true;
                    stopButton.disabled = false;
                    statusDot.classList.remove('status-idle');
                    statusDot.classList.add('status-recording');
                    startButton.childNodes[2].nodeValue = ' Đang ghi...';
                    showUIMessage("Bắt đầu ghi âm...");
                    if (permissionNotice) permissionNotice.style.display = 'none';
                    if (saveTranslationButton) saveTranslationButton.style.display = 'none'; 
                    lastFinalTranscript = ""; 
                    translationQueue = []; 
                };

                recognition.onresult = (event) => {
                    clearTimeout(finalTranscriptTimer);
                    let interimTranscript = '';
                    let finalTranscriptSegment = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscriptSegment += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    if (originalTextBox) {
                        originalTextBox.innerHTML = lastFinalTranscript + finalTranscriptSegment + '<i class="text-gray-400">' + interimTranscript + '</i>';
                        originalTextBox.scrollTop = originalTextBox.scrollHeight; 
                    }

                    if (finalTranscriptSegment.trim() !== '') {
                        const currentFullFinalTranscript = (lastFinalTranscript + finalTranscriptSegment).trim();
                        finalTranscriptTimer = setTimeout(() => {
                            if (currentFullFinalTranscript.trim() !== '' && currentFullFinalTranscript !== lastFinalTranscript.trim()) { 
                                console.log("Final transcript segment to send:", finalTranscriptSegment.trim());
                                
                                const placeholderId = `translating-${Date.now()}`;
                                const tempP = document.createElement('p');
                                tempP.id = placeholderId;
                                tempP.innerHTML = `<span class="text-gray-400">Đang dịch: "${finalTranscriptSegment.trim()}"<span class="spinner"></span></span>`;
                                if (translatedTextBox) {
                                    translatedTextBox.insertBefore(tempP, translatedTextBox.firstChild);
                                }

                                translationQueue.push({ 
                                    segment: finalTranscriptSegment.trim(), 
                                    fullText: currentFullFinalTranscript,
                                    placeholderId: placeholderId 
                                });
                                processTranslationQueue(); 

                                lastFinalTranscript = currentFullFinalTranscript + " "; 
                            }
                        }, FINAL_TRANSCRIPT_TIMEOUT);
                    }
                };

                recognition.onerror = (event) => {
                    console.error("Speech recognition error:", event.error, event.message);
                    let errorMessageText = "Lỗi nhận dạng giọng nói: "; 
                    if (event.error === 'no-speech') {
                        errorMessageText += "Không phát hiện thấy giọng nói. Vui lòng thử lại.";
                    } else if (event.error === 'audio-capture') {
                        errorMessageText += "Không thể thu âm. Kiểm tra microphone của bạn.";
                    } else if (event.error === 'not-allowed') {
                        errorMessageText = "Quyền truy cập microphone bị từ chối. Vui lòng kiểm tra cài đặt trình duyệt: \n1. Nhấp vào biểu tượng ổ khóa trên thanh địa chỉ. \n2. Tìm Microphone và chọn 'Allow'. \n3. Tải lại trang.";
                        if (permissionNotice) {
                            permissionNotice.style.display = 'block';
                            permissionNotice.innerHTML = "<b>Quan trọng:</b> Quyền truy cập microphone đã bị từ chối. <br/>Làm theo hướng dẫn để cấp quyền và tải lại trang.";
                        }
                    } else {
                        errorMessageText += event.error + (event.message ? ` (${event.message})` : '');
                    }
                    showUIMessage(errorMessageText, 7000);
                    stopSpeechRecognition(); 
                };

                recognition.onend = () => {
                    if (isRecording) {
                        console.log("Speech recognition ended unexpectedly or timed out.");
                        processTranslationQueue();
                    } else {
                        console.log("Speech recognition ended by user or completed normally.");
                    }
                    if (startButton && startButton.disabled) {
                        isRecording = false;
                        startButton.disabled = false;
                        if (stopButton) stopButton.disabled = true;
                        if (statusDot) {
                            statusDot.classList.remove('status-recording');
                            statusDot.classList.add('status-idle');
                        }
                        if (startButton.childNodes[2]) startButton.childNodes[2].nodeValue = ' Bắt đầu';
                        clearTimeout(finalTranscriptTimer);
                    }
                };
            } else {
                showUIMessage("Trình duyệt không hỗ trợ Web Speech API. Dùng Google Chrome.", 5000);
                if (startButton) startButton.disabled = true;
                if (stopButton) stopButton.disabled = true;
                if (permissionNotice) {
                    permissionNotice.innerHTML = "Trình duyệt không hỗ trợ Web Speech API. Dùng Google Chrome.";
                    permissionNotice.style.display = 'block';
                }
            }
        }
        
        // Initial setup
        updateLanguageLabels();
        initializeSpeechRecognition(); 

        sourceLangSelect.addEventListener('change', () => {
            updateLanguageLabels();
            initializeSpeechRecognition(); 
            if (isRecording) stopSpeechRecognition(); 
            showUIMessage(`Ngôn ngữ nói đổi thành: ${languageMap[sourceLangSelect.value]?.name}`, 2000);
        });

        targetLangSelect.addEventListener('change', () => {
            updateLanguageLabels();
            showUIMessage(`Ngôn ngữ dịch đổi thành: ${languageMap[targetLangSelect.value]?.name}`, 2000);
        });

        swapLangButton.addEventListener('click', () => {
            const currentSource = sourceLangSelect.value;
            const currentTarget = targetLangSelect.value;
            
            if (currentSource === "en-US" && currentTarget === "vi") {
                sourceLangSelect.value = "vi-VN";
                targetLangSelect.value = "en";
            } else if (currentSource === "vi-VN" && currentTarget === "en") {
                sourceLangSelect.value = "en-US";
                targetLangSelect.value = "vi";
            }
            
            updateLanguageLabels();
            initializeSpeechRecognition();
            if (isRecording) stopSpeechRecognition();
            showUIMessage("Đã đảo chiều ngôn ngữ.", 2000);
        });


        if (startButton) {
            startButton.addEventListener('click', () => {
                if (!generativeAIModel) {
                     showUIMessage("Dịch vụ AI chưa sẵn sàng. Vui lòng kiểm tra console để biết lỗi.", 5000);
                     return;
                }
                if (recognition) {
                    if (originalTextBox) originalTextBox.innerHTML = ''; 
                    if (translatedTextBox) translatedTextBox.innerHTML = ''; 
                    lastFinalTranscript = ""; 
                    currentOriginalForSave = ""; 
                    currentTranslatedForSave = ""; 
                    translationQueue = []; 
                    try {
                        recognition.lang = sourceLangSelect.value; 
                        recognition.start();
                    } catch (e) {
                        console.error("Error starting recognition:", e);
                        if (e.name === 'InvalidStateError' && isRecording) {
                            showUIMessage("Ghi âm đã được bắt đầu.", 2000);
                        } else {
                            showUIMessage("Không thể bắt đầu ghi âm. Lỗi: " + e.message, 5000);
                            stopSpeechRecognition();
                        }
                    }
                }
            });
        }

        if (stopButton) {
            stopButton.addEventListener('click', () => {
                stopSpeechRecognition();
                processTranslationQueue(); 
                showUIMessage("Đã dừng ghi âm.", 2000);
            });
        }

        function stopSpeechRecognition() { 
            if (recognition && isRecording) {
                recognition.stop();
            }
            isRecording = false;
            if (startButton) startButton.disabled = false;
            if (stopButton) stopButton.disabled = true;
            if (statusDot) {
                statusDot.classList.remove('status-recording');
                statusDot.classList.add('status-idle');
            }
            if (startButton && startButton.childNodes[2]) startButton.childNodes[2].nodeValue = ' Bắt đầu';
            clearTimeout(finalTranscriptTimer);
        }
        
        let currentOriginalForSave = "";
        let currentTranslatedForSave = "";

        async function sendToTranslateWithFirebaseAI(textSegment, fullOriginalText, placeholderId) {
            if (!textSegment || textSegment.trim() === '') return;
            if (!generativeAIModel) {
                showUIMessage("Lỗi: Dịch vụ AI chưa sẵn sàng để dịch.", 5000);
                const errorP = document.getElementById(placeholderId);
                if (errorP) errorP.innerHTML = `<span class="text-red-500">[Lỗi AI Service]</span>`;
                else if (translatedTextBox) translatedTextBox.innerHTML = `<p><span class="text-red-500">[Lỗi AI Service]</span></p>` + translatedTextBox.innerHTML;
                return;
            }
            currentOriginalForSave = fullOriginalText.trim(); 

            const targetElement = document.getElementById(placeholderId); 

            try {
                const sourceLangForPrompt = languageMap[sourceLangSelect.value]?.geminiName || "auto";
                const targetLangForPrompt = languageMap[targetLangSelect.value]?.geminiName || "Vietnamese";
                
                const prompt = `Provide a direct translation of the following ${sourceLangForPrompt} text to ${targetLangForPrompt}, without explanations or additional context: "${textSegment}"`;
                
                console.log("Sending prompt to Gemini:", prompt);
                
                const streamResult = await generativeAIModel.generateContentStream(prompt);

                let accumulatedTranslatedTextForSegment = "";
                let firstChunk = true;

                for await (const item of streamResult.stream) {
                    const chunkText = item.text();
                    console.log("Stream chunk:", chunkText);
                    accumulatedTranslatedTextForSegment += chunkText;
                    
                    if (targetElement) {
                        if (firstChunk) {
                            targetElement.innerHTML = `<span class="text-sm font-semibold text-blue-600">${chunkText.trim()}</span>`;
                            firstChunk = false;
                        } else {
                            targetElement.querySelector('span.text-blue-600').textContent += chunkText;
                        }
                    } 
                }
                
                currentTranslatedForSave = accumulatedTranslatedTextForSegment.trim() + (currentTranslatedForSave ? " " + currentTranslatedForSave : ""); 

                if(auth.currentUser && saveTranslationButton && accumulatedTranslatedTextForSegment.trim() !== "") {
                    saveTranslationButton.style.display = 'inline-block';
                }
                if (accumulatedTranslatedTextForSegment.trim() === "" && targetElement) { 
                     targetElement.innerHTML = `<span class="text-red-500">[Không nhận được bản dịch]</span>`;
                }

            } catch (error) {
                console.error("Lỗi khi dịch (Firebase AI Logic Stream):", error);
                showUIMessage("Lỗi khi dịch (AI Stream): " + error.message, 7000);
                if (targetElement) {
                    targetElement.innerHTML = `<span class="text-red-500">[Lỗi dịch (AI Stream): ${error.message}]</span>`;
                } 
            }
        }

        // --- UI Action Buttons ---
        if(clearOriginalTextBtn) {
            clearOriginalTextBtn.addEventListener('click', () => {
                if(originalTextBox) originalTextBox.innerHTML = '';
                lastFinalTranscript = ""; 
                currentOriginalForSave = "";
                showUIMessage("Đã xóa văn bản gốc.", 1500);
            });
        }

        if(clearTranslatedTextBtn) {
            clearTranslatedTextBtn.addEventListener('click', () => {
                if(translatedTextBox) translatedTextBox.innerHTML = '';
                currentTranslatedForSave = "";
                if(saveTranslationButton) saveTranslationButton.style.display = 'none';
                showUIMessage("Đã xóa bản dịch.", 1500);
            });
        }

        if(copyTranslatedTextBtn) {
            copyTranslatedTextBtn.addEventListener('click', () => {
                if(translatedTextBox && translatedTextBox.textContent.trim() !== "") {
                    const textToCopy = Array.from(translatedTextBox.querySelectorAll('p span.text-blue-600'))
                                                .map(span => span.textContent.trim())
                                                .join('\n'); 

                        if (textToCopy) {
                            navigator.clipboard.writeText(textToCopy)
                                .then(() => showUIMessage("Đã sao chép bản dịch!", 1500))
                                .catch(err => {
                                    console.error('Lỗi sao chép: ', err);
                                    try {
                                        const textArea = document.createElement("textarea");
                                        textArea.value = textToCopy;
                                        document.body.appendChild(textArea);
                                        textArea.focus();
                                        textArea.select();
                                        document.execCommand('copy');
                                        document.body.removeChild(textArea);
                                        showUIMessage("Đã sao chép bản dịch! (fallback)", 1500);
                                    } catch (fallbackErr) {
                                        console.error('Lỗi sao chép (fallback): ', fallbackErr);
                                        showUIMessage("Lỗi khi sao chép.", 2000);
                                    }
                                });
                        } else {
                             showUIMessage("Không có nội dung dịch để sao chép.", 1500);
                        }
                } else {
                    showUIMessage("Không có gì để sao chép.", 1500);
                }
            });
        }


        // Firebase Auth
        if (registerButton) {
            registerButton.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                if (!email || !password) {
                    showUIMessage("Vui lòng nhập email và mật khẩu."); return;
                }
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showUIMessage("Đăng ký thành công!");
                    emailInput.value = ''; passwordInput.value = '';
                } catch (error) {
                    showUIMessage("Lỗi đăng ký: " + error.message, 5000);
                }
            });
        }

        if (loginButton) {
            loginButton.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                if (!email || !password) {
                    showUIMessage("Vui lòng nhập email và mật khẩu."); return;
                }
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showUIMessage("Đăng nhập thành công!");
                    emailInput.value = ''; passwordInput.value = '';
                } catch (error) {
                    showUIMessage("Lỗi đăng nhập: " + error.message, 5000);
                }
            });
        }

        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showUIMessage("Đã đăng xuất.");
                } catch (error) {
                    showUIMessage("Lỗi đăng xuất: " + error.message, 5000);
                }
            });
        }
        
        let unsubscribeHistory = null; 

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (authForm) authForm.style.display = 'none';
                if (userInfo) userInfo.style.display = 'block';
                if (userEmailDisplay) userEmailDisplay.textContent = `Chào, ${user.email}`;
                if (authStatus) authStatus.textContent = `Đã đăng nhập với tư cách ${user.email}`;
                if(currentOriginalForSave && currentTranslatedForSave && saveTranslationButton) { 
                    saveTranslationButton.style.display = 'inline-block';
                }
                if (historyContainer) historyContainer.style.display = 'block';
                loadTranslationHistory(user.uid); 
            } else {
                if (authForm) authForm.style.display = 'block';
                if (userInfo) userInfo.style.display = 'none';
                if (userEmailDisplay) userEmailDisplay.textContent = '';
                if (authStatus) authStatus.textContent = 'Chưa đăng nhập.';
                if (saveTranslationButton) saveTranslationButton.style.display = 'none'; 
                if (historyContainer) historyContainer.style.display = 'none';
                if (translationHistoryDiv) translationHistoryDiv.innerHTML = '<p class="text-center text-gray-500 text-sm">Đăng nhập để xem lịch sử.</p>';
                if (unsubscribeHistory) {
                    unsubscribeHistory(); 
                    unsubscribeHistory = null;
                }
            }
        });

        // Firestore - Save Translation
        if (saveTranslationButton) {
            saveTranslationButton.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) {
                    showUIMessage("Bạn cần đăng nhập để lưu bản dịch.", 3000); return;
                }
                if (!currentOriginalForSave || !currentTranslatedForSave) {
                    showUIMessage("Không có bản dịch nào để lưu.", 3000); return;
                }
                try {
                    await addDoc(collection(db, "translations"), {
                        userId: user.uid,
                        originalText: currentOriginalForSave,
                        translatedText: currentTranslatedForSave,
                        sourceLang: sourceLangSelect.value, 
                        targetLang: targetLangSelect.value, 
                        createdAt: serverTimestamp() 
                    });
                    showUIMessage("Đã lưu bản dịch thành công!", 3000);
                    currentOriginalForSave = ""; 
                    currentTranslatedForSave = "";
                    saveTranslationButton.style.display = 'none';
                } catch (e) {
                    showUIMessage("Lỗi khi lưu bản dịch: " + e.message, 5000);
                }
            });
        }

        // Firestore - Load Translation History
        async function loadTranslationHistory(userId) {
            if (!translationHistoryDiv) return;
            translationHistoryDiv.innerHTML = '<p class="text-center text-gray-500 text-sm">Đang tải lịch sử...</p>';

            const translationsRef = collection(db, "translations");
            const q = query(translationsRef, 
                            where("userId", "==", userId), 
                            orderBy("createdAt", "desc"), 
                            limit(10));
            
            if (unsubscribeHistory) {
                unsubscribeHistory();
            }

            unsubscribeHistory = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    translationHistoryDiv.innerHTML = '<p class="text-center text-gray-500 text-sm">Chưa có lịch sử nào.</p>';
                    return;
                }
                translationHistoryDiv.innerHTML = ''; 
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    const sourceLangDisplay = languageMap[data.sourceLang]?.name || data.sourceLang;
                    const targetLangDisplay = languageMap[data.targetLang]?.name || data.targetLang;

                    const originalP = document.createElement('p');
                    originalP.className = 'original';
                    originalP.textContent = `Gốc (${sourceLangDisplay}): ${data.originalText}`;
                    
                    const translatedP = document.createElement('p');
                    translatedP.className = 'translated';
                    translatedP.textContent = `Dịch (${targetLangDisplay}): ${data.translatedText}`;
                    
                    const timestampP = document.createElement('p');
                    timestampP.className = 'timestamp';
                    timestampP.textContent = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('vi-VN') : 'Không có thời gian';
                    
                    historyItem.appendChild(originalP);
                    historyItem.appendChild(translatedP);
                    historyItem.appendChild(timestampP);
                    translationHistoryDiv.insertBefore(historyItem, translationHistoryDiv.firstChild); 
                });
            }, (error) => {
                console.error("Lỗi khi tải lịch sử: ", error);
                translationHistoryDiv.innerHTML = '<p class="text-center text-red-500 text-sm">Lỗi khi tải lịch sử.</p>';
                showUIMessage("Lỗi tải lịch sử: " + error.message, 5000);
            });
        }
    </script>
</body>
</html>
